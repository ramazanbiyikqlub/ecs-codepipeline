    name: AWS Rollback
    on:
      workflow_dispatch:
    env:
      AWS_REGION: "eu-west-3"
      ECR_REPOSITORY: "nodejs-1"
      ECS_SERVICE: "nodejs-service"
      ECS_CLUSTER: "ramazan-test-1"
      ECS_TASK_DEFINITION: ".aws/task-definition.staging.paris.json"
      CONTAINER_NAME: "nodejs-test"
      
    
    jobs:
      Set-variables:
        name: "Rollback"
        runs-on: ubuntu-latest
        environment: production
        steps:
          - name: Configure AWS credentials
            uses: aws-actions/configure-aws-credentials@v1-node16
            with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: ${{ env.AWS_REGION }}
            
          - name: Login to Amazon ECR
            id: login-ecr
            uses: aws-actions/amazon-ecr-login@v1
            
          - name: Set Current Task Revision
            id: current-revision
            env:
              ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
              IMAGE_TAG: ${{ steps.date.outputs.date }}-${{ steps.vars.outputs.sha_short }}
            run: |
              echo "REVISION_NUMBER=$(aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --query "services[].taskDefinition" --services ${{ env.ECS_SERVICE }} --output text | cut -d: -f7)" >> $GITHUB_ENV
              echo "REVISION_NAME=$(aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --query "services[].taskDefinition" --services ${{ env.ECS_SERVICE }} --output text | cut -d: -f1-6)" >> $GITHUB_ENV
    
          - name: Set Previous Task Revision Number
            id: previous-revision-number
            run: |
              echo "PREVIOUS_REVISION_NUMBER"=$((${{ env.REVISION_NUMBER }}-1)) >> $GITHUB_ENV

          - name: Check Variables with script
            id: check-variables
            env:
              PREVIOUS_REVISION_NUMBER: ${{ env.PREVIOUS_REVISION_NUMBER }}
            run: |
               pwd
               chmod +x ${GITHUB_WORKSPACE}/.github/workflows/check-variables.sh
               ./${GITHUB_WORKSPACE}/.github/workflows/check-variables.shcheck-variables.sh ${{ env.ECR_REPOSITORY }} $PREVIOUS_REVISION_NUMBER
               echo "From github action: ${{ env.PREVIOUS_REVISION_NUMBER }}"
            shell: bash

          # - name: Set Previous Task Revision Image Tag
          #   id: previous-revision-image-tag
          #   env:
          #     PREVIOUS_REVISION_NUMBER: ${{ env.PREVIOUS_REVISION_NUMBER }}
          #   run: |
          #     echo "IMAGE_TAG"=$(aws ecs describe-task-definition --task-definition "${{ env.ECR_REPOSITORY }}:$PREVIOUS_REVISION_NUMBER" --query "taskDefinition.containerDefinitions[0].image" --output text |cut -d: -f2) >> $GITHUB_ENV

          # - name: Check if previous revision image is exist or not
          #   id: tag-checker
          #   env:
          #     IMAGE_TAG: ${{ env.IMAGE_TAG }}
          #   run: |
          #     if (aws ecr describe-images --repository-name=${{ env.ECR_REPOSITORY }} --image-ids=imageTag=$IMAGE_TAG &> /dev/null); then
          #       echo "Image Found"
          #     else
          #       echo 'Image is Not Found'
          #     fi
              
          # - name: Check if previous task revision exist or not
          #   id: revision-checker
          #   env:
          #     PREVIOUS_REVISION_NUMBER: ${{ env.PREVIOUS_REVISION_NUMBER }}
          #   run: |
          #     if (aws ecs describe-task-definition --task-definition "${{ env.ECR_REPOSITORY }}:$PREVIOUS_REVISION_NUMBER" --output text &> /dev/null); then
          #       echo "Task definition Found"
          #     else
          #       echo 'Task definition not Found'
          #     fi

          - name: Rollback to previous version
            id: rollback
            run: |
              echo 'rickrolled'
          #     aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.ECS_SERVICE }} --task-definition ${{ env.REVISION_NAME }}:${{ env.PREVIOUS_REVISION_NUMBER }}

